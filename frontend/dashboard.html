<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FedIDS - Security Operations Center</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-primary: #3b82f6;
            --border: #475569;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .dashboard-container {
            display: grid;
            grid-template-areas: 
                "header header"
                "sidebar main";
            /* Slightly increased sidebar width for better readability */
            grid-template-columns: 300px 1fr;
            grid-template-rows: 70px 1fr;
            height: 100vh;
        }

        .header {
            grid-area: header;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 24px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: var(--accent-primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .logout-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: var(--danger);
            color: white;
            border-color: var(--danger);
        }

        .sidebar {
            grid-area: sidebar;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            padding: 24px 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
            border-left-color: var(--accent-primary);
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            grid-area: main;
            padding: 24px;
            overflow-y: auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            border-color: var(--accent-primary);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-icon.threats {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .stat-icon.blocked {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .stat-icon.alerts {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .stat-icon.accuracy {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-change {
            font-size: 12px;
            font-weight: 500;
        }

        .stat-change.positive {
            color: var(--success);
        }

        .stat-change.negative {
            color: var(--danger);
        }

        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-action {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .card-action:hover {
            background: #2563eb;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .upload-area.dragover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .upload-icon {
            font-size: 48px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .upload-text {
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        .upload-button {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .results-container {
            grid-column: 1 / -1;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .results-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .results-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            padding: 12px 16px;
            text-align: left;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .results-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        .results-table tr:hover {
            background: rgba(59, 130, 246, 0.05);
        }

        .threat-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .threat-badge.high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .threat-badge.medium {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .threat-badge.low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .threat-badge.normal {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-primary);
        }

        @media (max-width: 1024px) {
            .dashboard-container {
                /* Slightly narrower sidebar on medium screens */
                grid-template-columns: 260px 1fr;
            }
            
            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-areas: 
                    "header"
                    "main";
                grid-template-columns: 1fr;
                grid-template-rows: 70px 1fr;
            }
            
            .sidebar {
                display: none;
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .alert.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .alert.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
        }

        .stats-grid {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .chart-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
        }

        .chart-container h3 {
            color: var(--text-primary);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-panel {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-panel h3 {
            color: var(--danger);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alert-item {
            background: var(--bg-tertiary);
            border-left: 3px solid var(--danger);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .alert-item:hover {
            background: var(--bg-primary);
        }

        .upload-section {
            background: var(--bg-secondary);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 32px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.2s ease;
        }

        .upload-section:hover {
            border-color: var(--accent-primary);
            background: var(--bg-tertiary);
        }

        .upload-btn {
            background: var(--accent-primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .upload-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .nav-item i {
            margin-right: 12px;
            width: 16px;
            text-align: center;
        }

        .threat-level {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .threat-high { background: var(--danger); color: white; }
        .threat-medium { background: var(--warning); color: white; }
        .threat-low { background: var(--success); color: white; }
        .threat-critical { background: #b91c1c; color: white; border: 1px solid var(--danger); }

        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 20px;
        }

        .loading i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* System status styling */
        .system-status {
            margin-top: 16px;
            padding: 16px 24px 12px 24px;
            border-top: 1px solid var(--border);
        }

        .system-status h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .status-item {
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-item:last-child {
            margin-bottom: 0;
        }

        .status-label {
            color: var(--text-secondary);
            font-size: 1.05em;
        }

        .status-value {
            color: var(--success);
            font-weight: 600;
            font-size: 1.05em;
        }

        /* Site footer */
        .site-footer {
            margin-top: 24px;
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            color: var(--text-secondary);
            text-align: center;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <div class="logo">
                <i class="fas fa-shield-alt"></i> FedIDS
            </div>
            <div class="user-info">
                <div id="connection-status">
                    <i class="fas fa-circle" style="color: var(--danger);"></i>
                    <span>Connecting...</span>
                </div>
                <div id="user-profile">
                    <i class="fas fa-user-shield"></i>
                    <span id="username">Loading...</span>
                </div>
                <button onclick="logout()" style="background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='var(--danger)'">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <div class="sidebar">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showSection('detection')">
                <i class="fas fa-search"></i>
                <span>Threat Detection</span>
            </div>
            <div class="nav-item" onclick="window.location.href='explainable-ai.html'">
                <i class="fas fa-brain"></i>
                <span>AI Analysis</span>
            </div>
            <div class="nav-item" onclick="window.location.href='awareness.html'">
                <i class="fas fa-graduation-cap"></i>
                <span>Security Awareness</span>
            </div>

            <div class="system-status">
                <h4>System Status</h4>
                <div class="status-item">
                    <span class="status-label">Model Accuracy:</span>
                    <span class="status-value">92.88%</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Active Clients:</span>
                    <span class="status-value">3</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Update:</span>
                    <span class="status-value" id="last-update">Just now</span>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-scans">0</div>
                    <div class="stat-label">Total Scans</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="threats-detected">0</div>
                    <div class="stat-label">Threats Detected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="normal-traffic">0</div>
                    <div class="stat-label">Normal Traffic</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="active-connections">0</div>
                    <div class="stat-label">Active Connections</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>
                    <i class="fas fa-chart-line"></i> Threat Detection Timeline
                </h3>
                <div id="threat-timeline" style="height: 420px;"></div>
            </div>

            <div class="content-grid" style="margin-top: 24px;">
                <div class="chart-container">
                    <h3>
                        <i class="fas fa-bolt"></i> Intrusion Types Distribution
                    </h3>
                    <div id="attack-type-chart" style="height: 420px;"></div>
                </div>
                <div class="chart-container">
                    <h3>
                        <i class="fas fa-exclamation-circle"></i> Severity Breakdown
                    </h3>
                    <div id="severity-pie-chart" style="height: 420px;"></div>
                </div>
            </div>

            <div class="alert-panel">
                <h3>
                    <i class="fas fa-exclamation-triangle"></i> Live Threat Alerts
                </h3>
                <div id="alerts-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i> Monitoring network traffic...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detection Section (Hidden by default) -->
    <div id="detection-section" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-primary); z-index: 1000; padding: 20px;">
        <div style="max-width: 1200px; margin: 0 auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                <h2 style="color: var(--text-primary); font-weight: 700;">
                    <i class="fas fa-search"></i> Threat Detection Center
                </h2>
                <button onclick="hideDetectionSection()" style="background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
            </div>

            <div class="upload-section">
                <h3 style="color: var(--text-primary); margin-bottom: 20px; font-weight: 600;">Upload Network Traffic Data</h3>
                <input type="file" id="file-upload" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
                <button class="upload-btn" onclick="document.getElementById('file-upload').click()">
                    <i class="fas fa-upload"></i> Select CSV File
                </button>
                <p style="color: var(--text-muted); margin-top: 15px;">Supported formats: CSV files with network traffic features</p>
            </div>

            <div id="detection-results" style="display: none;">
                <h3 style="color: var(--text-primary); margin-bottom: 20px; font-weight: 600;">Detection Results</h3>
                <div id="results-summary" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 24px; margin-bottom: 20px;"></div>
                <div id="results-table" style="background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 24px; max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = (location.origin && location.origin.startsWith('http')) ? location.origin : 'http://localhost:5000';
        let socket;
        let currentUser = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication
            const token = localStorage.getItem('fedids_token');
            const user = localStorage.getItem('fedids_user');
            
            if (!token || !user) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = JSON.parse(user);
            document.getElementById('username').textContent = currentUser.username;

            // Initialize WebSocket connection
            initializeWebSocket(API_BASE);
            
            // Load initial data
            loadSystemStats();
            
            // Initialize charts
            initializeCharts();
        });

        function initializeWebSocket(API_BASE) {
            socket = io(API_BASE, { path: '/socket.io' });
            
            socket.on('connect', function() {
                document.getElementById('connection-status').innerHTML = 
                    '<i class="fas fa-circle" style="color: var(--success);"></i><span>Connected</span>';
            });

            socket.on('disconnect', function() {
                document.getElementById('connection-status').innerHTML = 
                    '<i class="fas fa-circle" style="color: var(--danger);"></i><span>Disconnected</span>';
            });

            // Backend emits 'threat_detected' with threat details
            socket.on('threat_detected', function(threat) {
                addNewAlert(threat);
                incrementCountsFromThreat(threat);
                appendTimelinePoint();
                renderAttackTypeChart();
                renderSeverityChart();
                // Update simple stats counters
                const td = Number(document.getElementById('threats-detected').textContent || '0') + 1;
                document.getElementById('threats-detected').textContent = td;
                document.getElementById('total-scans').textContent = Number(document.getElementById('total-scans').textContent || '0') + 1;
            });

            // Backend emits 'system_stats' with system metrics
            socket.on('system_stats', function(stats) {
                // Active connections if present
                if (typeof stats.active_connections !== 'undefined') {
                    document.getElementById('active-connections').textContent = stats.active_connections;
                }
                document.getElementById('last-update').textContent = 'Just now';
            });
        }

        async function loadSystemStats() {
            try {
                // Load recent threats history for alerts and seed charts
                const threatsRes = await fetch(`${API_BASE}/api/threat-history`);
                const threatsData = await threatsRes.json();
                if (threatsData && threatsData.success) {
                    loadAlerts(threatsData.threats);
                    // Seed counts from history
                    resetCounts();
                    (threatsData.threats || []).forEach(t => incrementCountsFromThreat(t));
                    renderAttackTypeChart();
                    renderSeverityChart();
                    document.getElementById('threats-detected').textContent = threatsData.summary?.total_threats || 0;
                }

                // Load model/system stats
                const modelRes = await fetch(`${API_BASE}/api/model-stats`);
                const modelData = await modelRes.json();
                if (modelData && modelData.success) {
                    // Show accuracy if provided
                    // You can map it to the sidebar or a card in future if needed
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('total-scans').textContent = stats.total_scans || 0;
            document.getElementById('threats-detected').textContent = stats.threats_detected || 0;
            document.getElementById('normal-traffic').textContent = stats.normal_traffic || 0;
            document.getElementById('last-update').textContent = 'Just now';
        }

        function loadAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            container.innerHTML = '';
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 20px;">No recent alerts</div>';
                return;
            }

            alerts.forEach(alert => addAlertToContainer(alert, container));
        }

        function addNewAlert(alert) {
            const container = document.getElementById('alerts-container');
            addAlertToContainer(alert, container, true);
            
            // Remove old alerts if too many
            const alerts = container.children;
            if (alerts && alerts.length > 10) {
                container.removeChild(alerts[alerts.length - 1]);
            }
        }

        function addAlertToContainer(alert, container, prepend = false) {
            const alertElement = document.createElement('div');
            alertElement.className = 'alert-item';
            alertElement.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong style="color: var(--text-primary);">${alert.type}</strong>
                        <span class="threat-level threat-${alert.severity.toLowerCase()}">${alert.severity}</span>
                    </div>
                    <div style="color: var(--text-muted); font-size: 0.9em;">${new Date(alert.timestamp).toLocaleTimeString()}</div>
                </div>
                <div style="margin-top: 10px; color: var(--text-secondary);">
                    <div>Source: ${alert.source_ip || 'Unknown'}</div>
                    <div>Target: ${alert.target_ip || 'Unknown'}</div>
                    <div>Confidence: ${alert.confidence ? (alert.confidence * 100).toFixed(1) : '0.0'}%</div>
                </div>
            `;
            
            if (prepend) {
                container.insertBefore(alertElement, container.firstChild);
            } else {
                container.appendChild(alertElement);
            }
        }

        // State for charts
        let threatTimelineX = [];
        let threatTimelineY = [];
        let attackTypeCounts = {};
        let severityCounts = {};

        function resetCounts() {
            attackTypeCounts = { 'DoS': 0, 'Probe': 0, 'R2L': 0, 'U2R': 0, 'Normal': 0 };
            severityCounts = { 'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0 };
        }

        function incrementCountsFromThreat(threat) {
            if (!threat) return;
            const t = (threat.type || threat.attack_type || 'Unknown');
            const s = (threat.severity || 'Low');
            if (typeof attackTypeCounts[t] === 'undefined') attackTypeCounts[t] = 0;
            if (typeof severityCounts[s] === 'undefined') severityCounts[s] = 0;
            attackTypeCounts[t] += 1;
            severityCounts[s] += 1;
        }

        function initializeCharts() {
            // Timeline chart
            Plotly.newPlot('threat-timeline', [
                { x: [], y: [], type: 'scatter', mode: 'lines+markers', name: 'Threats Detected', line: { color: '#ef4444', width: 3 }, marker: { color: '#ef4444', size: 8 } }
            ], {
                title: { text: '<b>Real-time Threat Detection</b>', font: { color: '#ffffff', size: 22 } },
                xaxis: { title: { text: '<b>Time</b>', font: { size: 16, color: '#ffffff' } }, tickfont: { size: 14, color: '#ffffff' }, gridcolor: 'rgba(148,163,184,0.2)' },
                yaxis: { title: { text: '<b>Threat Count</b>', font: { size: 16, color: '#ffffff' } }, tickfont: { size: 14, color: '#ffffff' }, gridcolor: 'rgba(148,163,184,0.2)' },
                legend: { font: { size: 14, color: '#ffffff' } },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff', size: 14 },
                margin: { l: 60, r: 30, t: 60, b: 60 }
            });

            // Attack type bar chart
            renderAttackTypeChart();

            // Severity pie chart
            renderSeverityChart();
        }

        function renderAttackTypeChart() {
            const labels = Object.keys(attackTypeCounts);
            const values = labels.map(k => attackTypeCounts[k]);
            Plotly.react('attack-type-chart', [{
                x: labels,
                y: values,
                type: 'bar',
                marker: { color: '#3b82f6' }
            }], {
                title: { text: '<b>Intrusion Types</b>', font: { color: '#ffffff', size: 22 } },
                xaxis: { title: { text: '<b>Type</b>', font: { size: 16, color: '#ffffff' } }, tickfont: { size: 14, color: '#ffffff' } },
                yaxis: { title: { text: '<b>Count</b>', font: { size: 16, color: '#ffffff' } }, tickfont: { size: 14, color: '#ffffff' } },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff', size: 14 },
                margin: { l: 60, r: 30, t: 60, b: 60 }
            });
        }

        function renderSeverityChart() {
            const labels = Object.keys(severityCounts);
            const values = labels.map(k => severityCounts[k]);
            Plotly.react('severity-pie-chart', [{
                labels: labels,
                values: values,
                type: 'pie',
                marker: { colors: ['#ef4444', '#f59e0b', '#fde047', '#10b981'] },
                textinfo: 'label+percent',
                textfont: { size: 16, color: '#ffffff' }
            }], {
                title: { text: '<b>Severity Breakdown</b>', font: { color: '#ffffff', size: 22 } },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#ffffff', size: 14 },
                legend: { font: { size: 14, color: '#ffffff' } },
                margin: { l: 30, r: 30, t: 60, b: 30 }
            });
        }

        function appendTimelinePoint() {
            const now = new Date();
            threatTimelineX.push(now);
            const last = threatTimelineY.length > 0 ? threatTimelineY[threatTimelineY.length - 1] : 0;
            threatTimelineY.push(last + 1);
            Plotly.extendTraces('threat-timeline', { x: [[now]], y: [[last + 1]] }, [0]);
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                // Show loading
                document.getElementById('detection-results').style.display = 'block';
                document.getElementById('results-summary').innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Analyzing file...</div>';

                // Read file as text and parse CSV
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (!lines || lines.length < 2) {
                    throw new Error('CSV file must have at least a header and one data row');
                }
                
                const headers = lines[0].split(',').map(h => h.trim());

                // Parse CSV data
                const data = [];
                for (let i = 1; i < Math.min(lines ? lines.length : 0, 101); i++) { // Limit to 100 rows
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        const value = values[index] ? values[index].trim() : '';
                        row[header] = isNaN(value) ? value : parseFloat(value);
                    });
                    data.push(row);
                }

                // Send data to backend for analysis
                const response = await fetch(`${API_BASE}/api/predict`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('fedids_token')}`
                    },
                    body: JSON.stringify({ 
                        sample_data: Object.values(data[0]).filter(v => typeof v === 'number').slice(0, 20),
                        batch_data: data 
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayDetectionResults(result);
                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                document.getElementById('results-summary').innerHTML = 
                    `<div style="color: var(--danger);">Error: ${error.message}</div>`;
            }
        }

        function displayDetectionResults(result) {
            const summary = result.summary;
            const results = result.batch_results || result.results || [];

            // Display summary
            document.getElementById('results-summary').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                    <div style="text-align: center;">
                        <div style="font-size: 2em; color: var(--text-primary); font-weight: 700;">${summary.total_samples}</div>
                        <div style="color: var(--text-secondary);">Total Samples</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; color: var(--danger); font-weight: 700;">${summary.threats_detected}</div>
                        <div style="color: var(--text-secondary);">Threats Detected</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; color: var(--success); font-weight: 700;">${summary.normal_traffic}</div>
                        <div style="color: var(--text-secondary);">Normal Traffic</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 2em; color: var(--accent-primary); font-weight: 700;">${
                            typeof summary.accuracy === 'number' 
                                ? (summary.accuracy * 100).toFixed(0) 
                                : '0'
                        }%</div>
                        <div style="color: var(--text-secondary);">Model Accuracy</div>
                    </div>
                </div>
            `;

            // Display results table with scrolling
            let tableHTML = `
                <div style="margin-bottom: 15px; color: var(--text-primary);">
                    <strong>Showing ${Math.min(results ? results.length : 0, 100)} of ${results ? results.length : 0} results</strong>
                    ${results && results.length > 100 ? ' (Limited to first 100 for performance)' : ''}
                </div>
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px;">
                    <table style="width: 100%; border-collapse: collapse; color: var(--text-primary);">
                        <thead style="position: sticky; top: 0; background: var(--bg-tertiary); z-index: 10;">
                            <tr>
                                <th style="padding: 12px; border: 1px solid var(--border); text-align: left;">Sample ID</th>
                                <th style="padding: 12px; border: 1px solid var(--border); text-align: left;">Prediction</th>
                                <th style="padding: 12px; border: 1px solid var(--border); text-align: center;">Confidence</th>
                                <th style="padding: 12px; border: 1px solid var(--border); text-align: center;">Severity</th>
                                <th style="padding: 12px; border: 1px solid var(--border); text-align: center;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // Show up to 100 results for performance
            if (results && results.length > 0) {
                results.slice(0, 100).forEach(result => {
                const severityClass = `threat-${result.severity.toLowerCase()}`;
                const rowColor = result.prediction !== "Normal" ? 'var(--bg-tertiary)' : 'var(--bg-secondary)';
                tableHTML += `
                    <tr style="background: ${rowColor}; transition: background 0.2s ease;" onmouseover="this.style.background='var(--bg-primary)'" onmouseout="this.style.background='${rowColor}'">
                        <td style="padding: 10px; border: 1px solid var(--border);">#${result.id}</td>
                        <td style="padding: 10px; border: 1px solid var(--border); font-weight: 600; color: ${result.prediction !== "Normal" ? 'var(--danger)' : 'var(--success)'};">${result.prediction}</td>
                        <td style="padding: 10px; border: 1px solid var(--border); text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <div style="width: 60px; height: 8px; background: var(--bg-primary); border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${result.confidence ? result.confidence * 100 : 0}%; height: 100%; background: var(--accent-primary); border-radius: 4px;"></div>
                                </div>
                                <span style="font-size: 0.9em;">${result.confidence ? (result.confidence * 100).toFixed(1) : '0.0'}%</span>
                            </div>
                        </td>
                        <td style="padding: 10px; border: 1px solid var(--border); text-align: center;">
                            <span class="threat-level ${severityClass}">${result.severity}</span>
                        </td>
                        <td style="padding: 10px; border: 1px solid var(--border); text-align: center;">
                            <button onclick="window.location.href='explainable-ai.html'" style="background: var(--accent-primary); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='var(--accent-primary)'">
                                <i class="fas fa-brain"></i> Explain
                            </button>
                        </td>
                    </tr>
                `;
                });
            }

            tableHTML += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('results-table').innerHTML = tableHTML;
        }

        function showSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.nav-item').classList.add('active');

            // Hide all sections
            document.getElementById('detection-section').style.display = 'none';
            
            // Show requested section
            if (section === 'detection') {
                document.getElementById('detection-section').style.display = 'block';
            }
            // Add other sections as needed
        }

        function hideDetectionSection() {
            document.getElementById('detection-section').style.display = 'none';
        }

        function explainPrediction(sampleId) {
            alert(`Explainable AI analysis for sample ${sampleId} will be implemented in the next step!`);
        }

        function logout() {
            localStorage.removeItem('fedids_token');
            localStorage.removeItem('fedids_user');
            window.location.href = 'login.html';
        }
    </script>
    <footer class="site-footer">
        &copy; <span id="year"></span> Privacy-Preserving Intrusion Detection System using Federated Learning
    </footer>
    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
    </script>
</body>
</html>
